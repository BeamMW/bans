{"version":3,"sources":["../src/module.ts"],"names":["builtins","assert","buffer","child_process","cluster","console","constants","crypto","dgram","dns","domain","events","fs","http","https","module","net","os","path","punycode","process","querystring","readline","repl","stream","string_decoder","sys","timers","tls","tty","url","util","vm","zlib","cache","NOOP","createCustomDebug","depth","_args","namespaces","arg1","args","modulePrefix","cookModuleId","rawId","replace","Module","constructor","filename","options","debuggerDepth","id","extensions","NativeModule","_extensions","added","forEach","ext","push","_resolveFilename","Object","assign","debug","require","resolve","isAbsolute","Error","dependencies","cacheKey","only","imports","has","get","sort","length","join","m","transform","includes","extname","code","readFileSync","test","exports","JSON","parse","evaluate","ensure","paths","defineProperties","value","writable","freeze","_nodeModulePaths","dirname","text","matchedRules","rules","filter","RegExp","reverse","EvalCache","action","evaluator","default","name","script","Script","runInContext","createContext","clearImmediate","clearInterval","clearTimeout","setImmediate","setInterval","setTimeout","global","__filename","__dirname","set","invalidate","invalidateEvalCache","clear"],"mappings":"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","sourcesContent":["/**\n * This is a custom implementation for the module system for evaluating code,\n * used for resolving values for dependencies interpolated in `css` or `styled`.\n *\n * This serves 2 purposes:\n * - Avoid leakage from evaluated code to module cache in current context, e.g. `babel-register`\n * - Allow us to invalidate the module cache without affecting other stuff, necessary for rebuilds\n *\n * We also use it to transpile the code with Babel by default.\n * We also store source maps for it to provide correct error stacktraces.\n *\n */\n\nimport NativeModule from 'module';\nimport vm from 'vm';\nimport fs from 'fs';\nimport path from 'path';\nimport type { BabelFileResult } from '@babel/core';\nimport { debug } from '@linaria/logger';\nimport * as EvalCache from './eval-cache';\nimport * as process from './process';\nimport type { Evaluator, StrictOptions } from './types';\n\n// Supported node builtins based on the modules polyfilled by webpack\n// `true` means module is polyfilled, `false` means module is empty\nconst builtins = {\n  assert: true,\n  buffer: true,\n  child_process: false,\n  cluster: false,\n  console: true,\n  constants: true,\n  crypto: true,\n  dgram: false,\n  dns: false,\n  domain: true,\n  events: true,\n  fs: false,\n  http: true,\n  https: true,\n  module: false,\n  net: false,\n  os: true,\n  path: true,\n  punycode: true,\n  process: true,\n  querystring: true,\n  readline: false,\n  repl: false,\n  stream: true,\n  string_decoder: true,\n  sys: true,\n  timers: true,\n  tls: false,\n  tty: true,\n  url: true,\n  util: true,\n  vm: true,\n  zlib: true,\n};\n\n// Separate cache for evaluated modules\nlet cache: { [id: string]: Module } = {};\n\nconst NOOP = () => {};\n\nconst createCustomDebug =\n  (depth: number) =>\n  (..._args: Parameters<typeof debug>) => {\n    const [namespaces, arg1, ...args] = _args;\n    const modulePrefix = depth === 0 ? 'module' : `sub-module-${depth}`;\n    debug(`${modulePrefix}:${namespaces}`, arg1, ...args);\n  };\n\nconst cookModuleId = (rawId: string) => {\n  // It's a dirty hack for avoiding conflicts with babel-preset-react-app\n  // https://github.com/callstack/linaria/issues/745\n  // FIXME @Anber: I'll try to figure out a better solution. Probably, using Terser as a shaker's core can solve problems with interfered plugins.\n  return rawId.replace(\n    '/@babel/runtime/helpers/esm/',\n    '/@babel/runtime/helpers/'\n  );\n};\n\nclass Module {\n  static invalidate: () => void;\n  static invalidateEvalCache: () => void;\n  static _resolveFilename: (\n    id: string,\n    options: { id: string; filename: string; paths: string[] }\n  ) => string;\n  static _nodeModulePaths: (filename: string) => string[];\n\n  id: string;\n  filename: string;\n  options: StrictOptions;\n  imports: Map<string, string[]> | null;\n  paths: string[];\n  exports: any;\n  extensions: string[];\n  dependencies: string[] | null;\n  transform: ((text: string) => BabelFileResult | null) | null;\n  debug: typeof debug;\n  debuggerDepth: number;\n\n  constructor(\n    filename: string,\n    options: StrictOptions,\n    debuggerDepth: number = 0\n  ) {\n    this.id = filename;\n    this.filename = filename;\n    this.options = options;\n    this.imports = null;\n    this.paths = [];\n    this.dependencies = null;\n    this.transform = null;\n    this.debug = createCustomDebug(debuggerDepth);\n    this.debuggerDepth = debuggerDepth;\n\n    Object.defineProperties(this, {\n      id: {\n        value: filename,\n        writable: false,\n      },\n      filename: {\n        value: filename,\n        writable: false,\n      },\n      paths: {\n        value: Object.freeze(\n          (\n            NativeModule as unknown as {\n              _nodeModulePaths(filename: string): string[];\n            }\n          )._nodeModulePaths(path.dirname(filename))\n        ),\n        writable: false,\n      },\n    });\n\n    this.exports = {};\n\n    // We support following extensions by default\n    this.extensions = ['.json', '.js', '.jsx', '.ts', '.tsx'];\n    this.debug('prepare', filename);\n  }\n\n  resolve = (rawId: string) => {\n    const id = cookModuleId(rawId);\n    const extensions = (\n      NativeModule as unknown as {\n        _extensions: { [key: string]: Function };\n      }\n    )._extensions;\n    const added: string[] = [];\n\n    try {\n      // Check for supported extensions\n      this.extensions.forEach((ext) => {\n        if (ext in extensions) {\n          return;\n        }\n\n        // When an extension is not supported, add it\n        // And keep track of it to clean it up after resolving\n        // Use noop for the transform function since we handle it\n        extensions[ext] = NOOP;\n        added.push(ext);\n      });\n\n      return Module._resolveFilename(id, this);\n    } finally {\n      // Cleanup the extensions we added to restore previous behaviour\n      added.forEach((ext) => delete extensions[ext]);\n    }\n  };\n\n  require: {\n    (id: string): any;\n    resolve: (id: string) => string;\n    ensure: () => void;\n    cache: typeof cache;\n  } = Object.assign(\n    (rawId: string) => {\n      const id = cookModuleId(rawId);\n      this.debug('require', id);\n      if (id in builtins) {\n        // The module is in the allowed list of builtin node modules\n        // Ideally we should prevent importing them, but webpack polyfills some\n        // So we check for the list of polyfills to determine which ones to support\n        if (builtins[id as keyof typeof builtins]) {\n          return require(id);\n        }\n\n        return null;\n      }\n\n      // Resolve module id (and filename) relatively to parent module\n      const filename = this.resolve(id);\n      if (filename === id && !path.isAbsolute(id)) {\n        // The module is a builtin node modules, but not in the allowed list\n        throw new Error(\n          `Unable to import \"${id}\". Importing Node builtins is not supported in the sandbox.`\n        );\n      }\n\n      this.dependencies?.push(id);\n\n      let cacheKey = filename;\n      let only: string[] = [];\n      if (this.imports?.has(id)) {\n        // We know what exactly we need from this module. Let's shake it!\n        only = this.imports.get(id)!.sort();\n        if (only.length === 0) {\n          // Probably the module is used as a value itself\n          // like `'The answer is ' + require('./module')`\n          only = ['default'];\n        }\n\n        cacheKey += `:${only.join(',')}`;\n      }\n\n      let m = cache[cacheKey];\n\n      if (!m) {\n        this.debug('cached:not-exist', id);\n        // Create the module if cached module is not available\n        m = new Module(filename, this.options, this.debuggerDepth + 1);\n        m.transform = this.transform;\n\n        // Store it in cache at this point with, otherwise\n        // we would end up in infinite loop with cyclic dependencies\n        cache[cacheKey] = m;\n\n        if (this.extensions.includes(path.extname(filename))) {\n          // To evaluate the file, we need to read it first\n          const code = fs.readFileSync(filename, 'utf-8');\n          if (/\\.json$/.test(filename)) {\n            // For JSON files, parse it to a JS object similar to Node\n            m.exports = JSON.parse(code);\n          } else {\n            // For JS/TS files, evaluate the module\n            // The module will be transpiled using provided transform\n            m.evaluate(code, only.includes('*') ? ['*'] : only);\n          }\n        } else {\n          // For non JS/JSON requires, just export the id\n          // This is to support importing assets in webpack\n          // The module will be resolved by css-loader\n          m.exports = id;\n        }\n      } else {\n        this.debug('cached:exist', id);\n      }\n\n      return m.exports;\n    },\n    {\n      ensure: NOOP,\n      cache,\n      resolve: this.resolve,\n    }\n  );\n\n  evaluate(text: string, only: string[] | null = null) {\n    const filename = this.filename;\n    const matchedRules = this.options.rules\n      .filter(({ test }) => {\n        if (!test) {\n          return true;\n        }\n\n        if (typeof test === 'function') {\n          // this is not a test\n          // eslint-disable-next-line jest/no-disabled-tests\n          return test(filename);\n        }\n\n        if (test instanceof RegExp) {\n          return test.test(filename);\n        }\n\n        return false;\n      })\n      .reverse();\n\n    const cacheKey = [this.filename, ...(only ?? [])];\n\n    if (EvalCache.has(cacheKey, text)) {\n      this.exports = EvalCache.get(cacheKey, text);\n      return;\n    }\n\n    let code: string | null | undefined;\n    const action = matchedRules.length > 0 ? matchedRules[0].action : 'ignore';\n    if (action === 'ignore') {\n      this.debug('ignore', `${filename}`);\n      code = text;\n    } else {\n      // Action can be a function or a module name\n      const evaluator: Evaluator =\n        typeof action === 'function' ? action : require(action).default;\n\n      // For JavaScript files, we need to transpile it and to get the exports of the module\n      let imports: Module['imports'];\n\n      this.debug('prepare-evaluation', this.filename, 'using', evaluator.name);\n\n      [code, imports] = evaluator(this.filename, this.options, text, only);\n      this.imports = imports;\n\n      this.debug(\n        'evaluate',\n        `${this.filename} (only ${(only || []).join(', ')}):\\n${code}`\n      );\n    }\n\n    const script = new vm.Script(\n      `(function (exports) { ${code}\\n})(exports);`,\n      {\n        filename: this.filename,\n      }\n    );\n\n    script.runInContext(\n      vm.createContext({\n        clearImmediate: NOOP,\n        clearInterval: NOOP,\n        clearTimeout: NOOP,\n        setImmediate: NOOP,\n        setInterval: NOOP,\n        setTimeout: NOOP,\n        global,\n        process,\n        module: this,\n        exports: this.exports,\n        require: this.require,\n        __filename: this.filename,\n        __dirname: path.dirname(this.filename),\n      })\n    );\n\n    EvalCache.set(cacheKey, text, this.exports);\n  }\n}\n\nModule.invalidate = () => {\n  cache = {};\n};\n\nModule.invalidateEvalCache = () => {\n  EvalCache.clear();\n};\n\n// Alias to resolve the module using node's resolve algorithm\n// This static property can be overriden by the webpack loader\n// This allows us to use webpack's module resolution algorithm\nModule._resolveFilename = (id, options) =>\n  (\n    NativeModule as unknown as {\n      _resolveFilename: (id: string, options: any) => string;\n    }\n  )._resolveFilename(id, options);\n\nModule._nodeModulePaths = (filename: string) =>\n  (\n    NativeModule as unknown as {\n      _nodeModulePaths: (filename: string) => string[];\n    }\n  )._nodeModulePaths(filename);\n\nexport default Module;\n"],"file":"module.js"}