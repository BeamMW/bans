{"version":3,"sources":["../src/module.ts"],"names":["NativeModule","vm","fs","path","debug","EvalCache","process","builtins","assert","buffer","child_process","cluster","console","constants","crypto","dgram","dns","domain","events","http","https","module","net","os","punycode","querystring","readline","repl","stream","string_decoder","sys","timers","tls","tty","url","util","zlib","cache","NOOP","createCustomDebug","depth","_args","namespaces","arg1","args","modulePrefix","cookModuleId","rawId","replace","Module","constructor","filename","options","debuggerDepth","id","extensions","_extensions","added","forEach","ext","push","_resolveFilename","Object","assign","require","resolve","isAbsolute","Error","dependencies","cacheKey","only","imports","has","get","sort","length","join","m","transform","includes","extname","code","readFileSync","test","exports","JSON","parse","evaluate","ensure","paths","defineProperties","value","writable","freeze","_nodeModulePaths","dirname","text","matchedRules","rules","filter","RegExp","reverse","action","evaluator","default","name","script","Script","runInContext","createContext","clearImmediate","clearInterval","clearTimeout","setImmediate","setInterval","setTimeout","global","__filename","__dirname","set","invalidate","invalidateEvalCache","clear"],"mappings":"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","sourcesContent":["/**\n * This is a custom implementation for the module system for evaluating code,\n * used for resolving values for dependencies interpolated in `css` or `styled`.\n *\n * This serves 2 purposes:\n * - Avoid leakage from evaluated code to module cache in current context, e.g. `babel-register`\n * - Allow us to invalidate the module cache without affecting other stuff, necessary for rebuilds\n *\n * We also use it to transpile the code with Babel by default.\n * We also store source maps for it to provide correct error stacktraces.\n *\n */\n\nimport NativeModule from 'module';\nimport vm from 'vm';\nimport fs from 'fs';\nimport path from 'path';\nimport type { BabelFileResult } from '@babel/core';\nimport { debug } from '@linaria/logger';\nimport * as EvalCache from './eval-cache';\nimport * as process from './process';\nimport type { Evaluator, StrictOptions } from './types';\n\n// Supported node builtins based on the modules polyfilled by webpack\n// `true` means module is polyfilled, `false` means module is empty\nconst builtins = {\n  assert: true,\n  buffer: true,\n  child_process: false,\n  cluster: false,\n  console: true,\n  constants: true,\n  crypto: true,\n  dgram: false,\n  dns: false,\n  domain: true,\n  events: true,\n  fs: false,\n  http: true,\n  https: true,\n  module: false,\n  net: false,\n  os: true,\n  path: true,\n  punycode: true,\n  process: true,\n  querystring: true,\n  readline: false,\n  repl: false,\n  stream: true,\n  string_decoder: true,\n  sys: true,\n  timers: true,\n  tls: false,\n  tty: true,\n  url: true,\n  util: true,\n  vm: true,\n  zlib: true,\n};\n\n// Separate cache for evaluated modules\nlet cache: { [id: string]: Module } = {};\n\nconst NOOP = () => {};\n\nconst createCustomDebug =\n  (depth: number) =>\n  (..._args: Parameters<typeof debug>) => {\n    const [namespaces, arg1, ...args] = _args;\n    const modulePrefix = depth === 0 ? 'module' : `sub-module-${depth}`;\n    debug(`${modulePrefix}:${namespaces}`, arg1, ...args);\n  };\n\nconst cookModuleId = (rawId: string) => {\n  // It's a dirty hack for avoiding conflicts with babel-preset-react-app\n  // https://github.com/callstack/linaria/issues/745\n  // FIXME @Anber: I'll try to figure out a better solution. Probably, using Terser as a shaker's core can solve problems with interfered plugins.\n  return rawId.replace(\n    '/@babel/runtime/helpers/esm/',\n    '/@babel/runtime/helpers/'\n  );\n};\n\nclass Module {\n  static invalidate: () => void;\n  static invalidateEvalCache: () => void;\n  static _resolveFilename: (\n    id: string,\n    options: { id: string; filename: string; paths: string[] }\n  ) => string;\n  static _nodeModulePaths: (filename: string) => string[];\n\n  id: string;\n  filename: string;\n  options: StrictOptions;\n  imports: Map<string, string[]> | null;\n  paths: string[];\n  exports: any;\n  extensions: string[];\n  dependencies: string[] | null;\n  transform: ((text: string) => BabelFileResult | null) | null;\n  debug: typeof debug;\n  debuggerDepth: number;\n\n  constructor(\n    filename: string,\n    options: StrictOptions,\n    debuggerDepth: number = 0\n  ) {\n    this.id = filename;\n    this.filename = filename;\n    this.options = options;\n    this.imports = null;\n    this.paths = [];\n    this.dependencies = null;\n    this.transform = null;\n    this.debug = createCustomDebug(debuggerDepth);\n    this.debuggerDepth = debuggerDepth;\n\n    Object.defineProperties(this, {\n      id: {\n        value: filename,\n        writable: false,\n      },\n      filename: {\n        value: filename,\n        writable: false,\n      },\n      paths: {\n        value: Object.freeze(\n          (\n            NativeModule as unknown as {\n              _nodeModulePaths(filename: string): string[];\n            }\n          )._nodeModulePaths(path.dirname(filename))\n        ),\n        writable: false,\n      },\n    });\n\n    this.exports = {};\n\n    // We support following extensions by default\n    this.extensions = ['.json', '.js', '.jsx', '.ts', '.tsx'];\n    this.debug('prepare', filename);\n  }\n\n  resolve = (rawId: string) => {\n    const id = cookModuleId(rawId);\n    const extensions = (\n      NativeModule as unknown as {\n        _extensions: { [key: string]: Function };\n      }\n    )._extensions;\n    const added: string[] = [];\n\n    try {\n      // Check for supported extensions\n      this.extensions.forEach((ext) => {\n        if (ext in extensions) {\n          return;\n        }\n\n        // When an extension is not supported, add it\n        // And keep track of it to clean it up after resolving\n        // Use noop for the transform function since we handle it\n        extensions[ext] = NOOP;\n        added.push(ext);\n      });\n\n      return Module._resolveFilename(id, this);\n    } finally {\n      // Cleanup the extensions we added to restore previous behaviour\n      added.forEach((ext) => delete extensions[ext]);\n    }\n  };\n\n  require: {\n    (id: string): any;\n    resolve: (id: string) => string;\n    ensure: () => void;\n    cache: typeof cache;\n  } = Object.assign(\n    (rawId: string) => {\n      const id = cookModuleId(rawId);\n      this.debug('require', id);\n      if (id in builtins) {\n        // The module is in the allowed list of builtin node modules\n        // Ideally we should prevent importing them, but webpack polyfills some\n        // So we check for the list of polyfills to determine which ones to support\n        if (builtins[id as keyof typeof builtins]) {\n          return require(id);\n        }\n\n        return null;\n      }\n\n      // Resolve module id (and filename) relatively to parent module\n      const filename = this.resolve(id);\n      if (filename === id && !path.isAbsolute(id)) {\n        // The module is a builtin node modules, but not in the allowed list\n        throw new Error(\n          `Unable to import \"${id}\". Importing Node builtins is not supported in the sandbox.`\n        );\n      }\n\n      this.dependencies?.push(id);\n\n      let cacheKey = filename;\n      let only: string[] = [];\n      if (this.imports?.has(id)) {\n        // We know what exactly we need from this module. Let's shake it!\n        only = this.imports.get(id)!.sort();\n        if (only.length === 0) {\n          // Probably the module is used as a value itself\n          // like `'The answer is ' + require('./module')`\n          only = ['default'];\n        }\n\n        cacheKey += `:${only.join(',')}`;\n      }\n\n      let m = cache[cacheKey];\n\n      if (!m) {\n        this.debug('cached:not-exist', id);\n        // Create the module if cached module is not available\n        m = new Module(filename, this.options, this.debuggerDepth + 1);\n        m.transform = this.transform;\n\n        // Store it in cache at this point with, otherwise\n        // we would end up in infinite loop with cyclic dependencies\n        cache[cacheKey] = m;\n\n        if (this.extensions.includes(path.extname(filename))) {\n          // To evaluate the file, we need to read it first\n          const code = fs.readFileSync(filename, 'utf-8');\n          if (/\\.json$/.test(filename)) {\n            // For JSON files, parse it to a JS object similar to Node\n            m.exports = JSON.parse(code);\n          } else {\n            // For JS/TS files, evaluate the module\n            // The module will be transpiled using provided transform\n            m.evaluate(code, only.includes('*') ? ['*'] : only);\n          }\n        } else {\n          // For non JS/JSON requires, just export the id\n          // This is to support importing assets in webpack\n          // The module will be resolved by css-loader\n          m.exports = id;\n        }\n      } else {\n        this.debug('cached:exist', id);\n      }\n\n      return m.exports;\n    },\n    {\n      ensure: NOOP,\n      cache,\n      resolve: this.resolve,\n    }\n  );\n\n  evaluate(text: string, only: string[] | null = null) {\n    const filename = this.filename;\n    const matchedRules = this.options.rules\n      .filter(({ test }) => {\n        if (!test) {\n          return true;\n        }\n\n        if (typeof test === 'function') {\n          // this is not a test\n          // eslint-disable-next-line jest/no-disabled-tests\n          return test(filename);\n        }\n\n        if (test instanceof RegExp) {\n          return test.test(filename);\n        }\n\n        return false;\n      })\n      .reverse();\n\n    const cacheKey = [this.filename, ...(only ?? [])];\n\n    if (EvalCache.has(cacheKey, text)) {\n      this.exports = EvalCache.get(cacheKey, text);\n      return;\n    }\n\n    let code: string | null | undefined;\n    const action = matchedRules.length > 0 ? matchedRules[0].action : 'ignore';\n    if (action === 'ignore') {\n      this.debug('ignore', `${filename}`);\n      code = text;\n    } else {\n      // Action can be a function or a module name\n      const evaluator: Evaluator =\n        typeof action === 'function' ? action : require(action).default;\n\n      // For JavaScript files, we need to transpile it and to get the exports of the module\n      let imports: Module['imports'];\n\n      this.debug('prepare-evaluation', this.filename, 'using', evaluator.name);\n\n      [code, imports] = evaluator(this.filename, this.options, text, only);\n      this.imports = imports;\n\n      this.debug(\n        'evaluate',\n        `${this.filename} (only ${(only || []).join(', ')}):\\n${code}`\n      );\n    }\n\n    const script = new vm.Script(\n      `(function (exports) { ${code}\\n})(exports);`,\n      {\n        filename: this.filename,\n      }\n    );\n\n    script.runInContext(\n      vm.createContext({\n        clearImmediate: NOOP,\n        clearInterval: NOOP,\n        clearTimeout: NOOP,\n        setImmediate: NOOP,\n        setInterval: NOOP,\n        setTimeout: NOOP,\n        global,\n        process,\n        module: this,\n        exports: this.exports,\n        require: this.require,\n        __filename: this.filename,\n        __dirname: path.dirname(this.filename),\n      })\n    );\n\n    EvalCache.set(cacheKey, text, this.exports);\n  }\n}\n\nModule.invalidate = () => {\n  cache = {};\n};\n\nModule.invalidateEvalCache = () => {\n  EvalCache.clear();\n};\n\n// Alias to resolve the module using node's resolve algorithm\n// This static property can be overriden by the webpack loader\n// This allows us to use webpack's module resolution algorithm\nModule._resolveFilename = (id, options) =>\n  (\n    NativeModule as unknown as {\n      _resolveFilename: (id: string, options: any) => string;\n    }\n  )._resolveFilename(id, options);\n\nModule._nodeModulePaths = (filename: string) =>\n  (\n    NativeModule as unknown as {\n      _nodeModulePaths: (filename: string) => string[];\n    }\n  )._nodeModulePaths(filename);\n\nexport default Module;\n"],"file":"module.js"}