{"version":3,"file":"index.js","names":["path","enhancedResolve","loaderUtils","EvalCache","Module","transform","debug","notify","getCacheInstance","castSourceMap","sourceMap","version","toString","undefined","outputCssLoader","require","resolve","webpack4Loader","content","inputSourceMap","async","resourcePath","clearForFile","resolveOptionsDefaults","conditionNames","extensions","preprocessor","extension","cacheProvider","resolveOptions","rest","getOptions","outputFileName","replace","webpackResolveOptions","_compilation","options","length","resolveSync","create","sync","mainFields","__dirname","__filename","e","alias","modules","result","originalResolveFilename","_resolveFilename","id","filename","res","dirname","addDependency","relative","process","cwd","pluginOptions","cssText","Buffer","from","cssSourceMapText","dependencies","forEach","dep","f","console","warn","then","cacheInstance","set","request","encodeURIComponent","stringifiedRequest","stringifyRequest","callback","code","catch","err"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport enhancedResolve from 'enhanced-resolve';\nimport loaderUtils from 'loader-utils';\nimport type { RawSourceMap } from 'source-map';\n\nimport type { Result } from '@linaria/babel-preset';\nimport { EvalCache, Module, transform } from '@linaria/babel-preset';\nimport { debug, notify } from '@linaria/logger';\n\nimport { getCacheInstance } from './cache';\n\ntype LoaderContext = Parameters<typeof loaderUtils.getOptions>[0];\n\nconst castSourceMap = <T extends { version: number } | { version: string }>(\n  sourceMap: T | null | undefined\n) =>\n  sourceMap\n    ? {\n        ...sourceMap,\n        version: sourceMap.version.toString(),\n      }\n    : undefined;\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\nexport default function webpack4Loader(\n  this: LoaderContext,\n  content: string,\n  inputSourceMap: RawSourceMap | null\n) {\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  EvalCache.clearForFile(this.resourcePath);\n\n  const resolveOptionsDefaults = {\n    conditionNames: ['require'],\n    extensions: ['.js', '.jsx', '.ts', '.tsx', '.json'],\n  };\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    resolveOptions = {},\n    ...rest\n  } = loaderUtils.getOptions(this) || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  // this._compilation is a deprecated API\n  // However there seems to be no other way to access webpack's resolver\n  // There is this.resolve, but it's asynchronous\n  // Another option is to read the webpack.config.js, but it won't work for programmatic usage\n  // This API is used by many loaders/plugins, so hope we're safe for a while\n  const webpackResolveOptions = this._compilation?.options.resolve;\n\n  // Resolved configuration contains empty list of extensions as a default value\n  // https://github.com/callstack/linaria/issues/855\n  if (webpackResolveOptions?.extensions?.length === 0) {\n    delete webpackResolveOptions.extensions;\n  }\n\n  // Let's try to create a resolver with the webpack config\n  let resolveSync = enhancedResolve.create.sync({\n    ...resolveOptionsDefaults,\n    ...(this._compilation?.options.resolve ?? {}),\n    ...resolveOptions,\n    mainFields: ['main'],\n  });\n\n  try {\n    // Try to resolve the current file\n    resolveSync(__dirname, __filename);\n  } catch (e) {\n    // Looks like one of the webpack plugins is async and the whole resolver became async\n    notify(\n      'The default webpack configuration cannot be used because some of the plugins are asynchronous. All plugins have been ignored. Please override `resolveOptions.plugins` in the Linaria configuration.'\n    );\n\n    // Fallback to synchronous resolve\n    resolveSync = enhancedResolve.create.sync({\n      ...resolveOptionsDefaults,\n      ...((webpackResolveOptions && {\n        alias: webpackResolveOptions.alias,\n        modules: webpackResolveOptions.modules,\n      }) ||\n        {}),\n      ...resolveOptions,\n    });\n  }\n\n  let result: Result;\n\n  const originalResolveFilename = Module._resolveFilename;\n\n  try {\n    // Use webpack's resolution when evaluating modules\n    Module._resolveFilename = (id, { filename }) => {\n      const res = resolveSync(path.dirname(filename), id);\n      this.addDependency(res);\n      return res;\n    };\n\n    result = transform(content, {\n      filename: path.relative(process.cwd(), this.resourcePath),\n      inputSourceMap: inputSourceMap ?? undefined,\n      pluginOptions: rest,\n      preprocessor,\n    });\n  } finally {\n    // Restore original behaviour\n    Module._resolveFilename = originalResolveFilename;\n  }\n\n  if (result.cssText) {\n    let { cssText } = result;\n\n    if (sourceMap) {\n      cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n        result.cssSourceMapText || ''\n      ).toString('base64')}*/`;\n    }\n\n    if (result.dependencies?.length) {\n      result.dependencies.forEach((dep) => {\n        try {\n          const f = resolveSync(path.dirname(this.resourcePath), dep);\n\n          this.addDependency(f);\n        } catch (e) {\n          // eslint-disable-next-line no-console\n          console.warn(`[linaria] failed to add dependency for: ${dep}`, e);\n        }\n      });\n    }\n\n    getCacheInstance(cacheProvider)\n      .then((cacheInstance) => cacheInstance.set(this.resourcePath, cssText))\n      .then(() => {\n        const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n          cacheProvider ?? ''\n        )}!${this.resourcePath}`;\n        const stringifiedRequest = loaderUtils.stringifyRequest(this, request);\n\n        return this.callback(\n          null,\n          `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n          castSourceMap(result.sourceMap)\n        );\n      })\n      .catch((err: Error) => this.callback(err));\n    return;\n  }\n\n  this.callback(null, result.code, castSourceMap(result.sourceMap));\n}\n"],"mappings":"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"}