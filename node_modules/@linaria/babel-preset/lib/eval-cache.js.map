{"version":3,"file":"eval-cache.js","names":["fileHashes","Map","evalCache","fileKeys","hash","text","createHash","update","digest","lastText","lastHash","memoizedHash","toKey","filename","exports","length","join","clear","clearForFile","keys","get","debug","forEach","key","delete","set","has","textHash","undefined","value","push"],"sources":["../src/eval-cache.ts"],"sourcesContent":["import { createHash } from 'crypto';\n\nimport { debug } from '@linaria/logger';\n\nconst fileHashes = new Map<string, string>();\nconst evalCache = new Map<string, unknown>();\nconst fileKeys = new Map<string, string[]>();\n\nconst hash = (text: string) => createHash('sha1').update(text).digest('base64');\n\nlet lastText = '';\nlet lastHash: string = hash(lastText);\n\nconst memoizedHash: typeof hash = (text) => {\n  if (lastText !== text) {\n    lastHash = hash(text);\n    lastText = text;\n  }\n\n  return lastHash;\n};\n\nconst toKey = (filename: string, exports: string[]) =>\n  exports.length > 0 ? `${filename}:${exports.join(',')}` : filename;\n\nexport const clear = () => {\n  fileHashes.clear();\n  evalCache.clear();\n  fileKeys.clear();\n};\n\nexport const clearForFile = (filename: string) => {\n  const keys = fileKeys.get(filename) ?? [];\n  if (keys.length === 0) {\n    return;\n  }\n\n  debug('eval-cache:clear-for-file', filename);\n\n  keys.forEach((key) => {\n    fileHashes.delete(key);\n    evalCache.delete(key);\n  });\n\n  fileKeys.set(filename, []);\n};\n\nexport const has = (\n  [filename, ...exports]: string[],\n  text: string\n): boolean => {\n  const key = toKey(filename, exports);\n  const textHash = memoizedHash(text);\n  debug('eval-cache:has', `${key} ${textHash}`);\n\n  return fileHashes.get(key) === textHash;\n};\n\nexport const get = (\n  [filename, ...exports]: string[],\n  text: string\n): unknown => {\n  const key = toKey(filename, exports);\n  const textHash = memoizedHash(text);\n  debug('eval-cache:get', `${key} ${textHash}`);\n\n  if (fileHashes.get(key) !== textHash) {\n    return undefined;\n  }\n\n  return evalCache.get(key);\n};\n\nexport const set = (\n  [filename, ...exports]: string[],\n  text: string,\n  value: unknown\n): void => {\n  const key = toKey(filename, exports);\n  const textHash = memoizedHash(text);\n  debug('eval-cache:set', `${key} ${textHash}`);\n\n  fileHashes.set(key, textHash);\n  evalCache.set(key, value);\n\n  if (!fileKeys.has(filename)) {\n    fileKeys.set(filename, []);\n  }\n\n  fileKeys.get(filename)!.push(key);\n};\n"],"mappings":"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"}