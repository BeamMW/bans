{"version":3,"file":"extract.js","names":["extract","babel","options","process","getTemplateProcessor","visitor","Program","enter","path","state","queue","rules","index","dependencies","replacements","debug","file","opts","filename","Module","invalidate","traverse","TaggedTemplateExpression","p","processTemplateExpression","valueCache","evaluateExpressions","push","forEach","item","exit","_","Object","keys","length","metadata","linaria"],"sources":["../src/extract.ts"],"sourcesContent":["/* eslint-disable no-param-reassign */\n\n/**\n * This is an entry point for styles extraction.\n * On enter, It:\n *  - traverse the code using visitors (TaggedTemplateExpression, ImportDeclaration)\n *  - schedule evaluation of lazy dependencies (those who are not simple expressions //TODO does they have it's name?)\n *  - let templateProcessor to save evaluated values in babel state as `replacements`.\n * On exit, It:\n *  - store result of extraction in babel's file metadata\n */\n\nimport type { NodePath, Visitor } from '@babel/traverse';\nimport type { Program } from '@babel/types';\n\nimport { debug } from '@linaria/logger';\n\nimport type { Core } from './babel';\nimport getTemplateProcessor from './evaluators/templateProcessor';\nimport Module from './module';\nimport type { State, StrictOptions } from './types';\nimport evaluateExpressions from './utils/evaluateExpressions';\nimport processTemplateExpression from './utils/processTemplateExpression';\n\nexport default function extract(\n  babel: Core,\n  options: StrictOptions\n): { visitor: Visitor<State> } {\n  const process = getTemplateProcessor(options);\n\n  return {\n    visitor: {\n      Program: {\n        enter(path: NodePath<Program>, state: State) {\n          // Collect all the style rules from the styles we encounter\n          state.queue = [];\n          state.rules = {};\n          state.index = -1;\n          state.dependencies = [];\n          state.replacements = [];\n          debug('extraction:start', state.file.opts.filename);\n\n          // Invalidate cache for module evaluation to get fresh modules\n          Module.invalidate();\n\n          // We need our transforms to run before anything else\n          // So we traverse here instead of a in a visitor\n          path.traverse({\n            TaggedTemplateExpression: (p) => {\n              processTemplateExpression(babel, 'extract', p, state, options);\n            },\n          });\n\n          const [dependencies, valueCache] = evaluateExpressions(\n            babel,\n            path,\n            state.queue,\n            options,\n            state.file.opts.filename\n          );\n\n          state.dependencies.push(...dependencies);\n\n          state.queue.forEach((item) => process(item, state, valueCache));\n        },\n        exit(_: unknown, state: State) {\n          if (Object.keys(state.rules).length) {\n            // Store the result as the file metadata under linaria key\n            state.file.metadata.linaria = {\n              rules: state.rules,\n              replacements: state.replacements,\n              dependencies: state.dependencies,\n            };\n          }\n\n          // Invalidate cache for module evaluation when we're done\n          Module.invalidate();\n\n          debug('extraction:end', state.file.opts.filename);\n        },\n      },\n    },\n  };\n}\n"],"mappings":";;;;;;;AAeA;;AAGA;;AACA;;AAEA;;AACA;;;;AAtBA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAce,SAASA,OAAT,CACbC,KADa,EAEbC,OAFa,EAGgB;EAC7B,MAAMC,OAAO,GAAG,IAAAC,0BAAA,EAAqBF,OAArB,CAAhB;EAEA,OAAO;IACLG,OAAO,EAAE;MACPC,OAAO,EAAE;QACPC,KAAK,CAACC,IAAD,EAA0BC,KAA1B,EAAwC;UAC3C;UACAA,KAAK,CAACC,KAAN,GAAc,EAAd;UACAD,KAAK,CAACE,KAAN,GAAc,EAAd;UACAF,KAAK,CAACG,KAAN,GAAc,CAAC,CAAf;UACAH,KAAK,CAACI,YAAN,GAAqB,EAArB;UACAJ,KAAK,CAACK,YAAN,GAAqB,EAArB;UACA,IAAAC,aAAA,EAAM,kBAAN,EAA0BN,KAAK,CAACO,IAAN,CAAWC,IAAX,CAAgBC,QAA1C,EAP2C,CAS3C;;UACAC,eAAA,CAAOC,UAAP,GAV2C,CAY3C;UACA;;;UACAZ,IAAI,CAACa,QAAL,CAAc;YACZC,wBAAwB,EAAGC,CAAD,IAAO;cAC/B,IAAAC,kCAAA,EAA0BvB,KAA1B,EAAiC,SAAjC,EAA4CsB,CAA5C,EAA+Cd,KAA/C,EAAsDP,OAAtD;YACD;UAHW,CAAd;UAMA,MAAM,CAACW,YAAD,EAAeY,UAAf,IAA6B,IAAAC,4BAAA,EACjCzB,KADiC,EAEjCO,IAFiC,EAGjCC,KAAK,CAACC,KAH2B,EAIjCR,OAJiC,EAKjCO,KAAK,CAACO,IAAN,CAAWC,IAAX,CAAgBC,QALiB,CAAnC;UAQAT,KAAK,CAACI,YAAN,CAAmBc,IAAnB,CAAwB,GAAGd,YAA3B;UAEAJ,KAAK,CAACC,KAAN,CAAYkB,OAAZ,CAAqBC,IAAD,IAAU1B,OAAO,CAAC0B,IAAD,EAAOpB,KAAP,EAAcgB,UAAd,CAArC;QACD,CAhCM;;QAiCPK,IAAI,CAACC,CAAD,EAAatB,KAAb,EAA2B;UAC7B,IAAIuB,MAAM,CAACC,IAAP,CAAYxB,KAAK,CAACE,KAAlB,EAAyBuB,MAA7B,EAAqC;YACnC;YACAzB,KAAK,CAACO,IAAN,CAAWmB,QAAX,CAAoBC,OAApB,GAA8B;cAC5BzB,KAAK,EAAEF,KAAK,CAACE,KADe;cAE5BG,YAAY,EAAEL,KAAK,CAACK,YAFQ;cAG5BD,YAAY,EAAEJ,KAAK,CAACI;YAHQ,CAA9B;UAKD,CAR4B,CAU7B;;;UACAM,eAAA,CAAOC,UAAP;;UAEA,IAAAL,aAAA,EAAM,gBAAN,EAAwBN,KAAK,CAACO,IAAN,CAAWC,IAAX,CAAgBC,QAAxC;QACD;;MA/CM;IADF;EADJ,CAAP;AAqDD"}