{"version":3,"file":"extract.js","names":["debug","getTemplateProcessor","Module","evaluateExpressions","processTemplateExpression","extract","babel","options","process","visitor","Program","enter","path","state","queue","rules","index","dependencies","replacements","file","opts","filename","invalidate","traverse","TaggedTemplateExpression","p","valueCache","push","forEach","item","exit","_","Object","keys","length","metadata","linaria"],"sources":["../src/extract.ts"],"sourcesContent":["/* eslint-disable no-param-reassign */\n\n/**\n * This is an entry point for styles extraction.\n * On enter, It:\n *  - traverse the code using visitors (TaggedTemplateExpression, ImportDeclaration)\n *  - schedule evaluation of lazy dependencies (those who are not simple expressions //TODO does they have it's name?)\n *  - let templateProcessor to save evaluated values in babel state as `replacements`.\n * On exit, It:\n *  - store result of extraction in babel's file metadata\n */\n\nimport type { NodePath, Visitor } from '@babel/traverse';\nimport type { Program } from '@babel/types';\n\nimport { debug } from '@linaria/logger';\n\nimport type { Core } from './babel';\nimport getTemplateProcessor from './evaluators/templateProcessor';\nimport Module from './module';\nimport type { State, StrictOptions } from './types';\nimport evaluateExpressions from './utils/evaluateExpressions';\nimport processTemplateExpression from './utils/processTemplateExpression';\n\nexport default function extract(\n  babel: Core,\n  options: StrictOptions\n): { visitor: Visitor<State> } {\n  const process = getTemplateProcessor(options);\n\n  return {\n    visitor: {\n      Program: {\n        enter(path: NodePath<Program>, state: State) {\n          // Collect all the style rules from the styles we encounter\n          state.queue = [];\n          state.rules = {};\n          state.index = -1;\n          state.dependencies = [];\n          state.replacements = [];\n          debug('extraction:start', state.file.opts.filename);\n\n          // Invalidate cache for module evaluation to get fresh modules\n          Module.invalidate();\n\n          // We need our transforms to run before anything else\n          // So we traverse here instead of a in a visitor\n          path.traverse({\n            TaggedTemplateExpression: (p) => {\n              processTemplateExpression(babel, 'extract', p, state, options);\n            },\n          });\n\n          const [dependencies, valueCache] = evaluateExpressions(\n            babel,\n            path,\n            state.queue,\n            options,\n            state.file.opts.filename\n          );\n\n          state.dependencies.push(...dependencies);\n\n          state.queue.forEach((item) => process(item, state, valueCache));\n        },\n        exit(_: unknown, state: State) {\n          if (Object.keys(state.rules).length) {\n            // Store the result as the file metadata under linaria key\n            state.file.metadata.linaria = {\n              rules: state.rules,\n              replacements: state.replacements,\n              dependencies: state.dependencies,\n            };\n          }\n\n          // Invalidate cache for module evaluation when we're done\n          Module.invalidate();\n\n          debug('extraction:end', state.file.opts.filename);\n        },\n      },\n    },\n  };\n}\n"],"mappings":"AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA,SAASA,KAAT,QAAsB,iBAAtB;AAGA,OAAOC,oBAAP,MAAiC,gCAAjC;AACA,OAAOC,MAAP,MAAmB,UAAnB;AAEA,OAAOC,mBAAP,MAAgC,6BAAhC;AACA,OAAOC,yBAAP,MAAsC,mCAAtC;AAEA,eAAe,SAASC,OAAT,CACbC,KADa,EAEbC,OAFa,EAGgB;EAC7B,MAAMC,OAAO,GAAGP,oBAAoB,CAACM,OAAD,CAApC;EAEA,OAAO;IACLE,OAAO,EAAE;MACPC,OAAO,EAAE;QACPC,KAAK,CAACC,IAAD,EAA0BC,KAA1B,EAAwC;UAC3C;UACAA,KAAK,CAACC,KAAN,GAAc,EAAd;UACAD,KAAK,CAACE,KAAN,GAAc,EAAd;UACAF,KAAK,CAACG,KAAN,GAAc,CAAC,CAAf;UACAH,KAAK,CAACI,YAAN,GAAqB,EAArB;UACAJ,KAAK,CAACK,YAAN,GAAqB,EAArB;UACAlB,KAAK,CAAC,kBAAD,EAAqBa,KAAK,CAACM,IAAN,CAAWC,IAAX,CAAgBC,QAArC,CAAL,CAP2C,CAS3C;;UACAnB,MAAM,CAACoB,UAAP,GAV2C,CAY3C;UACA;;UACAV,IAAI,CAACW,QAAL,CAAc;YACZC,wBAAwB,EAAGC,CAAD,IAAO;cAC/BrB,yBAAyB,CAACE,KAAD,EAAQ,SAAR,EAAmBmB,CAAnB,EAAsBZ,KAAtB,EAA6BN,OAA7B,CAAzB;YACD;UAHW,CAAd;UAMA,MAAM,CAACU,YAAD,EAAeS,UAAf,IAA6BvB,mBAAmB,CACpDG,KADoD,EAEpDM,IAFoD,EAGpDC,KAAK,CAACC,KAH8C,EAIpDP,OAJoD,EAKpDM,KAAK,CAACM,IAAN,CAAWC,IAAX,CAAgBC,QALoC,CAAtD;UAQAR,KAAK,CAACI,YAAN,CAAmBU,IAAnB,CAAwB,GAAGV,YAA3B;UAEAJ,KAAK,CAACC,KAAN,CAAYc,OAAZ,CAAqBC,IAAD,IAAUrB,OAAO,CAACqB,IAAD,EAAOhB,KAAP,EAAca,UAAd,CAArC;QACD,CAhCM;;QAiCPI,IAAI,CAACC,CAAD,EAAalB,KAAb,EAA2B;UAC7B,IAAImB,MAAM,CAACC,IAAP,CAAYpB,KAAK,CAACE,KAAlB,EAAyBmB,MAA7B,EAAqC;YACnC;YACArB,KAAK,CAACM,IAAN,CAAWgB,QAAX,CAAoBC,OAApB,GAA8B;cAC5BrB,KAAK,EAAEF,KAAK,CAACE,KADe;cAE5BG,YAAY,EAAEL,KAAK,CAACK,YAFQ;cAG5BD,YAAY,EAAEJ,KAAK,CAACI;YAHQ,CAA9B;UAKD,CAR4B,CAU7B;;;UACAf,MAAM,CAACoB,UAAP;UAEAtB,KAAK,CAAC,gBAAD,EAAmBa,KAAK,CAACM,IAAN,CAAWC,IAAX,CAAgBC,QAAnC,CAAL;QACD;;MA/CM;IADF;EADJ,CAAP;AAqDD"}