{"version":3,"file":"collectTemplateDependencies.js","names":["generator","debug","ValueType","getSource","getTagProcessor","throwIfInvalid","hoist","babel","ex","Identifier","idPath","isReferencedIdentifier","binding","scope","getBinding","node","name","path","bindingPath","referencePaths","parent","isVariableDeclarator","initPath","get","isIdentifier","forEach","referencePath","replaceWith","types","identifier","traverse","collectTemplateDependencies","state","options","t","quasi","quasis","expressions","length","expressionValues","map","isExpression","buildCodeFrameError","code","result","evaluate","value","confident","deopt","isTaggedTemplateExpression","context","asSelector","kind","VALUE","source","undefined","isFunctionExpression","isArrowFunctionExpression","originalExNode","cloneNode","hoistedExNode","LAZY","originalEx","FUNCTION","expressionValue"],"sources":["../../src/utils/collectTemplateDependencies.ts"],"sourcesContent":["/**\n * This file is a visitor that checks TaggedTemplateExpressions and look for Linaria css or styled templates.\n * For each template it makes a list of dependencies, try to evaluate expressions, and if it is not possible, mark them as lazy dependencies.\n */\n\nimport generator from '@babel/generator';\nimport type { NodePath } from '@babel/traverse';\nimport type {\n  Expression,\n  Identifier as IdentifierNode,\n  TaggedTemplateExpression,\n  TemplateElement,\n  TSType,\n} from '@babel/types';\n\nimport { debug } from '@linaria/logger';\n\nimport type { Core } from '../babel';\nimport type { StrictOptions, ExpressionValue, State } from '../types';\nimport { ValueType } from '../types';\n\nimport getSource from './getSource';\nimport getTagProcessor from './getTagProcessor';\nimport throwIfInvalid from './throwIfInvalid';\n\n/**\n * Hoist the node and its dependencies to the highest scope possible\n */\nfunction hoist(babel: Core, ex: NodePath<Expression | null>): void {\n  const Identifier = (idPath: NodePath<IdentifierNode>) => {\n    if (!idPath.isReferencedIdentifier()) {\n      return;\n    }\n    const binding = idPath.scope.getBinding(idPath.node.name);\n    if (!binding) return;\n    const { scope, path: bindingPath, referencePaths } = binding;\n    // parent here can be null or undefined in different versions of babel\n    if (!scope.parent) {\n      // It's a variable from global scope\n      return;\n    }\n\n    if (bindingPath.isVariableDeclarator()) {\n      const initPath = bindingPath.get('init') as NodePath<Expression | null>;\n      hoist(babel, initPath);\n      initPath.hoist(scope);\n      if (initPath.isIdentifier()) {\n        referencePaths.forEach((referencePath) => {\n          referencePath.replaceWith(babel.types.identifier(initPath.node.name));\n        });\n      }\n    }\n  };\n\n  if (ex.isIdentifier()) {\n    Identifier(ex);\n    return;\n  }\n\n  ex.traverse({\n    Identifier,\n  });\n}\n\nexport default function collectTemplateDependencies(\n  babel: Core,\n  path: NodePath<TaggedTemplateExpression>,\n  state: State,\n  options: Pick<StrictOptions, 'classNameSlug' | 'displayName' | 'evaluate'>\n): [quasis: NodePath<TemplateElement>[], expressionValues: ExpressionValue[]] {\n  const { types: t } = babel;\n  const quasi = path.get('quasi');\n  const quasis = quasi.get('quasis');\n  const expressions = quasi.get('expressions');\n\n  debug('template-parse:identify-expressions', expressions.length);\n\n  const expressionValues: ExpressionValue[] = expressions.map(\n    (ex: NodePath<Expression | TSType>): ExpressionValue => {\n      if (!ex.isExpression()) {\n        throw ex.buildCodeFrameError(\n          `The expression '${generator(ex.node).code}' is not supported.`\n        );\n      }\n\n      const result = ex.evaluate();\n      let value: unknown;\n      if (result.confident) {\n        value = result.value;\n      } else {\n        // @ts-expect-error result has deopt field, but it's not in types\n        const { deopt } = result as { deopt: NodePath };\n        // At least in some cases deopt contains an expression hidden behind an identifier\n        // If it is a TaggedTemplateExpression, we can get class name for it\n        if (deopt && deopt.isTaggedTemplateExpression()) {\n          const context = getTagProcessor(deopt, state, options);\n          if (context?.asSelector) {\n            return {\n              kind: ValueType.VALUE,\n              value: context.asSelector,\n              ex,\n              source: getSource(ex),\n            };\n          }\n        }\n      }\n\n      if (value !== undefined) {\n        throwIfInvalid(value, ex);\n        return {\n          kind: ValueType.VALUE,\n          value,\n          ex,\n          source: getSource(ex),\n        };\n      }\n\n      if (\n        options.evaluate &&\n        !(ex.isFunctionExpression() || ex.isArrowFunctionExpression())\n      ) {\n        // save original expression that may be changed during hoisting\n        const originalExNode = t.cloneNode(ex.node);\n\n        hoist(babel, ex as NodePath<Expression | null>);\n\n        // save hoisted expression to be used to evaluation\n        const hoistedExNode = t.cloneNode(ex.node);\n\n        // get back original expression to the tree\n        ex.replaceWith(originalExNode);\n\n        return {\n          kind: ValueType.LAZY,\n          ex: hoistedExNode,\n          originalEx: ex,\n          source: getSource(ex),\n        };\n      }\n\n      return { kind: ValueType.FUNCTION, ex, source: getSource(ex) };\n    }\n  );\n\n  debug(\n    'template-parse:evaluate-expressions',\n    expressionValues.map((expressionValue) =>\n      expressionValue.kind === ValueType.VALUE ? expressionValue.value : 'lazy'\n    )\n  );\n\n  return [quasis, expressionValues];\n}\n"],"mappings":"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"}