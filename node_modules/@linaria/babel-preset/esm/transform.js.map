{"version":3,"file":"transform.js","names":["path","parseSync","transformFromAstSync","SourceMapGenerator","stylis","debug","loadOptions","STYLIS_DECLARATION","posixSep","posix","sep","babelPreset","require","resolve","transformUrl","url","outputFilename","sourceFilename","platformPath","relative","dirname","split","join","shouldTransformCode","code","test","extractCssFromAst","babelFileResult","options","metadata","transformedCode","map","linaria","sourceMap","rules","replacements","dependencies","mappings","cssText","preprocessor","selector","text","use","context","decl","replace","match","p1","p2","p3","p4","filename","Object","keys","forEach","index","push","generated","line","column","original","start","name","source","atom","cssSourceMapText","length","generator","file","mapping","addMapping","setSourceContent","toString","transform","inputSourceMap","pluginOptions","babelOptions","ast","caller","rootMode","presets","babelrc","configFile","sourceMaps","sourceFileName"],"sources":["../src/transform.ts"],"sourcesContent":["/**\n * This file exposes transform function that:\n * - parse the passed code to AST\n * - transforms the AST using Linaria babel preset ('./babel/index.js) and additional config defined in Linaria config file or passed to bundler configuration.\n * - runs generated CSS files through default of user-defined preprocessor\n * - generates source maps for CSS files\n * - return transformed code (without Linaria template literals), generated CSS, source maps and babel metadata from transform step.\n */\n\nimport path from 'path';\n\nimport type { BabelFileMetadata, BabelFileResult } from '@babel/core';\nimport { parseSync, transformFromAstSync } from '@babel/core';\nimport type { Mapping } from 'source-map';\nimport { SourceMapGenerator } from 'source-map';\nimport stylis from 'stylis';\n\nimport { debug } from '@linaria/logger';\n\nimport type { LinariaMetadata, Options, PreprocessorFn, Result } from './types';\nimport loadOptions from './utils/loadOptions';\n\nconst STYLIS_DECLARATION = 1;\nconst posixSep = path.posix.sep;\nconst babelPreset = require.resolve('./index');\n\nexport function transformUrl(\n  url: string,\n  outputFilename: string,\n  sourceFilename: string,\n  platformPath: typeof path = path\n) {\n  // Replace asset path with new path relative to the output CSS\n  const relative = platformPath.relative(\n    platformPath.dirname(outputFilename),\n    // Get the absolute path to the asset from the path relative to the JS file\n    platformPath.resolve(platformPath.dirname(sourceFilename), url)\n  );\n\n  if (platformPath.sep === posixSep) {\n    return relative;\n  }\n\n  return relative.split(platformPath.sep).join(posixSep);\n}\n\nexport function shouldTransformCode(code: string): boolean {\n  return /\\b(styled|css)/.test(code);\n}\n\nexport function extractCssFromAst(\n  babelFileResult: BabelFileResult,\n  code: string,\n  options: Options\n): Result {\n  const { metadata, code: transformedCode, map } = babelFileResult;\n\n  if (\n    !metadata ||\n    !(metadata as BabelFileMetadata & { linaria: LinariaMetadata }).linaria\n  ) {\n    return {\n      code: transformedCode || '', // if there was only unused code we want to return transformed code which will be later removed by the bundler\n      sourceMap: map,\n    };\n  }\n\n  const { rules, replacements, dependencies } = (\n    metadata as BabelFileMetadata & {\n      linaria: LinariaMetadata;\n    }\n  ).linaria;\n  const mappings: Mapping[] = [];\n\n  let cssText = '';\n\n  let preprocessor: PreprocessorFn;\n  if (typeof options.preprocessor === 'function') {\n    // eslint-disable-next-line prefer-destructuring\n    preprocessor = options.preprocessor;\n  } else {\n    switch (options.preprocessor) {\n      case 'none':\n        preprocessor = (selector, text) => `${selector} {${text}}\\n`;\n        break;\n      case 'stylis':\n      default:\n        stylis.use(null)((context, decl) => {\n          const { outputFilename } = options;\n          if (context === STYLIS_DECLARATION && outputFilename) {\n            // When writing to a file, we need to adjust the relative paths inside url(..) expressions\n            // It'll allow css-loader to resolve an imported asset properly\n            return decl.replace(\n              /\\b(url\\(([\"']?))(\\.[^)]+?)(\\2\\))/g,\n              (match, p1, p2, p3, p4) =>\n                p1 + transformUrl(p3, outputFilename, options.filename) + p4\n            );\n          }\n\n          return decl;\n        });\n\n        preprocessor = stylis;\n    }\n  }\n\n  Object.keys(rules).forEach((selector, index) => {\n    mappings.push({\n      generated: {\n        line: index + 1,\n        column: 0,\n      },\n      original: rules[selector].start!,\n      name: selector,\n      source: '',\n    });\n\n    if (rules[selector].atom) {\n      // For atoms, we just directly insert cssText, to give the atomizer full control over the rules\n      cssText += `${rules[selector].cssText}\\n`;\n    } else {\n      // Run each rule through stylis to support nesting\n      cssText += `${preprocessor(selector, rules[selector].cssText)}\\n`;\n    }\n  });\n\n  return {\n    code: transformedCode || '',\n    cssText,\n    rules,\n    replacements,\n    dependencies,\n    sourceMap: map,\n\n    get cssSourceMapText() {\n      if (mappings?.length) {\n        const generator = new SourceMapGenerator({\n          file: options.filename.replace(/\\.js$/, '.css'),\n        });\n\n        mappings.forEach((mapping) =>\n          generator.addMapping({ ...mapping, source: options.filename })\n        );\n\n        generator.setSourceContent(options.filename, code);\n\n        return generator.toString();\n      }\n\n      return '';\n    },\n  };\n}\n\nexport default function transform(code: string, options: Options): Result {\n  // Check if the file contains `css` or `styled` words first\n  // Otherwise we should skip transforming\n  if (!shouldTransformCode(code)) {\n    return {\n      code,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  debug(\n    'transform',\n    `${options.filename} to ${options.outputFilename}\\n${code}`\n  );\n\n  const pluginOptions = loadOptions(options.pluginOptions);\n  const babelOptions = pluginOptions?.babelOptions ?? null;\n\n  // Parse the code first so babel uses user's babel config for parsing\n  // We don't want to use user's config when transforming the code\n  const ast = parseSync(code, {\n    ...babelOptions,\n    filename: options.filename,\n    caller: { name: 'linaria' },\n  });\n\n  const babelFileResult = transformFromAstSync(ast!, code, {\n    ...(babelOptions?.rootMode ? { rootMode: babelOptions.rootMode } : null),\n    filename: options.filename,\n    presets: [[babelPreset, pluginOptions]],\n    babelrc: false,\n    configFile: false,\n    sourceMaps: true,\n    sourceFileName: options.filename,\n    inputSourceMap: options.inputSourceMap,\n  })!;\n\n  return extractCssFromAst(babelFileResult, code, options);\n}\n"],"mappings":"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"}