{"version":3,"file":"index.js","names":["path","enhancedResolve","EvalCache","Module","transform","debug","notify","getCacheInstance","outputCssLoader","require","resolve","webpack5Loader","webpack5LoaderPlugin","content","inputSourceMap","convertSourceMap","value","filename","undefined","file","mappings","names","sources","version","async","resourcePath","clearForFile","resolveOptionsDefaults","conditionNames","extensions","sourceMap","preprocessor","extension","cacheProvider","resolveOptions","rest","getOptions","outputFileName","replace","webpackResolveOptions","_compilation","options","length","resolveSync","create","sync","mainFields","__dirname","__filename","e","alias","modules","result","originalResolveFilename","_resolveFilename","id","res","dirname","Error","addDependency","toString","relative","process","cwd","pluginOptions","cssText","Buffer","from","cssSourceMapText","dependencies","forEach","dep","f","console","warn","then","cacheInstance","set","request","encodeURIComponent","utils","contextify","context","rootContext","stringifiedRequest","JSON","stringify","callback","code","catch","err"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport enhancedResolve from 'enhanced-resolve';\nimport type { RawSourceMap } from 'source-map';\nimport type { RawLoaderDefinitionFunction } from 'webpack';\n\nimport type { Result, Preprocessor } from '@linaria/babel-preset';\nimport { EvalCache, Module, transform } from '@linaria/babel-preset';\nimport { debug, notify } from '@linaria/logger';\n\nimport type { ICache } from './cache';\nimport { getCacheInstance } from './cache';\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\ntype Loader = RawLoaderDefinitionFunction<{\n  sourceMap?: boolean;\n  preprocessor?: Preprocessor;\n  extension?: string;\n  cacheProvider?: string | ICache;\n  resolveOptions?: enhancedResolve.ResolveOptions;\n}>;\n\nconst webpack5Loader: Loader = function webpack5LoaderPlugin(\n  content,\n  inputSourceMap\n) {\n  function convertSourceMap(\n    value: typeof inputSourceMap,\n    filename: string\n  ): RawSourceMap | undefined {\n    if (typeof value === 'string' || !value) {\n      return undefined;\n    }\n\n    return {\n      ...value,\n      file: value.file ?? filename,\n      mappings: value.mappings ?? '',\n      names: value.names ?? [],\n      sources: value.sources ?? [],\n      version: value.version ?? 3,\n    };\n  }\n\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  EvalCache.clearForFile(this.resourcePath);\n\n  const resolveOptionsDefaults = {\n    conditionNames: ['require'],\n    extensions: ['.js', '.jsx', '.ts', '.tsx', '.json'],\n  };\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    resolveOptions = {},\n    ...rest\n  } = this.getOptions() || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  // this._compilation is a deprecated API\n  // However there seems to be no other way to access webpack's resolver\n  // There is this.resolve, but it's asynchronous\n  // Another option is to read the webpack.config.js, but it won't work for programmatic usage\n  // This API is used by many loaders/plugins, so hope we're safe for a while\n  const webpackResolveOptions = this._compilation?.options.resolve;\n\n  // Resolved configuration contains empty list of extensions as a default value\n  // https://github.com/callstack/linaria/issues/855\n  if (webpackResolveOptions?.extensions?.length === 0) {\n    delete webpackResolveOptions.extensions;\n  }\n\n  // Let's try to create a resolver with the webpack config\n  let resolveSync = enhancedResolve.create.sync({\n    ...resolveOptionsDefaults,\n    ...(webpackResolveOptions ?? {}),\n    ...resolveOptions,\n    mainFields: ['main'],\n  });\n\n  try {\n    // Try to resolve the current file\n    resolveSync(__dirname, __filename);\n  } catch (e) {\n    // Looks like one of the webpack plugins is async and the whole resolver became async\n    notify(\n      'The default webpack configuration cannot be used because some of the plugins are asynchronous. All plugins have been ignored. Please override `resolveOptions.plugins` in the Linaria configuration.'\n    );\n\n    // Fallback to synchronous resolve\n    resolveSync = enhancedResolve.create.sync({\n      ...resolveOptionsDefaults,\n      ...((webpackResolveOptions && {\n        alias: webpackResolveOptions.alias,\n        modules: webpackResolveOptions.modules,\n      }) ||\n        {}),\n      ...resolveOptions,\n    });\n  }\n\n  let result: Result;\n\n  const originalResolveFilename = Module._resolveFilename;\n\n  try {\n    // Use webpack's resolution when evaluating modules\n    Module._resolveFilename = (id, { filename }) => {\n      const res = resolveSync(path.dirname(filename), id);\n      if (!res) {\n        // enhanced-resolve v4 throws a error when dependency is missed\n        throw new Error('No result');\n      }\n\n      this.addDependency(res);\n      return res;\n    };\n\n    result = transform(content.toString(), {\n      filename: path.relative(process.cwd(), this.resourcePath),\n      inputSourceMap: convertSourceMap(inputSourceMap, this.resourcePath),\n      pluginOptions: rest,\n      preprocessor,\n    });\n  } finally {\n    // Restore original behaviour\n    Module._resolveFilename = originalResolveFilename;\n  }\n\n  if (result.cssText) {\n    let { cssText } = result;\n\n    if (sourceMap) {\n      cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n        result.cssSourceMapText || ''\n      ).toString('base64')}*/`;\n    }\n\n    if (result.dependencies?.length) {\n      result.dependencies.forEach((dep) => {\n        try {\n          const f = resolveSync(path.dirname(this.resourcePath), dep);\n          if (f) {\n            this.addDependency(f);\n          } else {\n            // eslint-disable-next-line no-console\n            console.warn(\n              `[linaria] ${dep} cannot be resolved in ${this.resourcePath}`\n            );\n          }\n        } catch (e) {\n          // eslint-disable-next-line no-console\n          console.warn(`[linaria] failed to add dependency for: ${dep}`, e);\n        }\n      });\n    }\n\n    getCacheInstance(cacheProvider)\n      .then((cacheInstance) => cacheInstance.set(this.resourcePath, cssText))\n      .then(() => {\n        const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n          typeof cacheProvider === 'string' ? cacheProvider : ''\n        )}!${this.resourcePath}`;\n        this.utils.contextify(this.context || this.rootContext, request);\n        const stringifiedRequest = JSON.stringify(\n          this.utils.contextify(this.context || this.rootContext, request)\n        );\n\n        return this.callback(\n          null,\n          `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n          result.sourceMap ?? undefined\n        );\n      })\n      .catch((err: Error) => this.callback(err));\n    return;\n  }\n\n  this.callback(null, result.code, result.sourceMap ?? undefined);\n};\n\nexport default webpack5Loader;\n"],"mappings":"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"}