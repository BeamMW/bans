{"version":3,"file":"index.js","names":["prepareForShake","filename","options","code","transformOptions","buildOptions","ast","presets","unshift","require","resolve","targets","plugins","useESModules","debug","JSON","stringify","transformed","transformSync","Error","program","shaker","text","only","shaken","imports","shake","shakenCode","generator"],"sources":["../src/index.ts"],"sourcesContent":["import { transformSync } from '@babel/core';\nimport generator from '@babel/generator';\nimport type { Program } from '@babel/types';\n\nimport type { Evaluator, StrictOptions } from '@linaria/babel-preset';\nimport { buildOptions } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport shake from './shaker';\n\nexport { default as buildDepsGraph } from './graphBuilder';\n\nfunction prepareForShake(\n  filename: string,\n  options: StrictOptions,\n  code: string\n): Program {\n  const transformOptions = buildOptions(filename, options);\n\n  transformOptions.ast = true;\n  transformOptions.presets!.unshift([\n    require.resolve('@babel/preset-env'),\n    {\n      targets: 'ie 11',\n    },\n  ]);\n  transformOptions.presets!.unshift([\n    require.resolve('@linaria/preeval'),\n    options,\n  ]);\n  transformOptions.plugins!.unshift(\n    require.resolve('babel-plugin-transform-react-remove-prop-types')\n  );\n  transformOptions.plugins!.unshift([\n    require.resolve('@babel/plugin-transform-runtime'),\n    { useESModules: false },\n  ]);\n\n  debug(\n    'evaluator:shaker:transform',\n    `Transform ${filename} with options ${JSON.stringify(\n      transformOptions,\n      null,\n      2\n    )}`\n  );\n  const transformed = transformSync(code, transformOptions);\n\n  if (transformed === null || !transformed.ast) {\n    throw new Error(`${filename} cannot be transformed`);\n  }\n\n  return transformed.ast.program;\n}\n\nconst shaker: Evaluator = (filename, options, text, only = null) => {\n  const [shaken, imports] = shake(\n    prepareForShake(filename, options, text),\n    only\n  );\n\n  debug('evaluator:shaker:generate', `Generate shaken source code ${filename}`);\n  const { code: shakenCode } = generator(shaken!);\n  return [shakenCode, imports];\n};\n\nexport default shaker;\n"],"mappings":";;;;;;;;;;;;;AAAA;;AACA;;AAIA;;AACA;;AAEA;;AAEA;;;;AAEA,SAASA,eAAT,CACEC,QADF,EAEEC,OAFF,EAGEC,IAHF,EAIW;EACT,MAAMC,gBAAgB,GAAG,IAAAC,yBAAA,EAAaJ,QAAb,EAAuBC,OAAvB,CAAzB;EAEAE,gBAAgB,CAACE,GAAjB,GAAuB,IAAvB;EACAF,gBAAgB,CAACG,OAAjB,CAA0BC,OAA1B,CAAkC,CAChCC,OAAO,CAACC,OAAR,CAAgB,mBAAhB,CADgC,EAEhC;IACEC,OAAO,EAAE;EADX,CAFgC,CAAlC;EAMAP,gBAAgB,CAACG,OAAjB,CAA0BC,OAA1B,CAAkC,CAChCC,OAAO,CAACC,OAAR,CAAgB,kBAAhB,CADgC,EAEhCR,OAFgC,CAAlC;EAIAE,gBAAgB,CAACQ,OAAjB,CAA0BJ,OAA1B,CACEC,OAAO,CAACC,OAAR,CAAgB,gDAAhB,CADF;EAGAN,gBAAgB,CAACQ,OAAjB,CAA0BJ,OAA1B,CAAkC,CAChCC,OAAO,CAACC,OAAR,CAAgB,iCAAhB,CADgC,EAEhC;IAAEG,YAAY,EAAE;EAAhB,CAFgC,CAAlC;EAKA,IAAAC,aAAA,EACE,4BADF,EAEG,aAAYb,QAAS,iBAAgBc,IAAI,CAACC,SAAL,CACpCZ,gBADoC,EAEpC,IAFoC,EAGpC,CAHoC,CAIpC,EANJ;EAQA,MAAMa,WAAW,GAAG,IAAAC,mBAAA,EAAcf,IAAd,EAAoBC,gBAApB,CAApB;;EAEA,IAAIa,WAAW,KAAK,IAAhB,IAAwB,CAACA,WAAW,CAACX,GAAzC,EAA8C;IAC5C,MAAM,IAAIa,KAAJ,CAAW,GAAElB,QAAS,wBAAtB,CAAN;EACD;;EAED,OAAOgB,WAAW,CAACX,GAAZ,CAAgBc,OAAvB;AACD;;AAED,MAAMC,MAAiB,GAAG,CAACpB,QAAD,EAAWC,OAAX,EAAoBoB,IAApB,EAA0BC,IAAI,GAAG,IAAjC,KAA0C;EAClE,MAAM,CAACC,MAAD,EAASC,OAAT,IAAoB,IAAAC,eAAA,EACxB1B,eAAe,CAACC,QAAD,EAAWC,OAAX,EAAoBoB,IAApB,CADS,EAExBC,IAFwB,CAA1B;EAKA,IAAAT,aAAA,EAAM,2BAAN,EAAoC,+BAA8Bb,QAAS,EAA3E;EACA,MAAM;IAAEE,IAAI,EAAEwB;EAAR,IAAuB,IAAAC,kBAAA,EAAUJ,MAAV,CAA7B;EACA,OAAO,CAACG,UAAD,EAAaF,OAAb,CAAP;AACD,CATD;;eAWeJ,M"}