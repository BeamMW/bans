{"version":3,"file":"DepsGraph.js","names":["addEdge","a","b","dependencies","has","get","edges","push","add","set","Set","dependents","DepsGraph","imports","Map","importAliases","importTypes","reexports","parents","WeakMap","exports","actionQueue","processQueue","length","forEach","action","resolvedA","resolveNode","resolvedB","call","getAllReferences","id","name","split","declaration","scope","getDeclaration","allReferences","Array","from","filter","i","t","isIdentifier","constructor","dependent","dependency","addExport","node","existed","addParent","parent","getParent","getDependenciesByBinding","includes","getDependentsByBinding","findDependencies","like","shallowEqual","map","findDependents","getDependencies","nodes","reduced","n","getLeaf","getLeaves","only","values"],"sources":["../src/DepsGraph.ts"],"sourcesContent":["import { types as t } from '@babel/core';\n\nimport type { PromisedNode } from './scope';\nimport type ScopeManager from './scope';\nimport { resolveNode } from './scope';\n\ntype Action = (this: DepsGraph, a: t.Node, b: t.Node) => void;\n\nfunction addEdge(this: DepsGraph, a: t.Node, b: t.Node) {\n  if (this.dependencies.has(a) && this.dependencies.get(a)!.has(b)) {\n    // edge has been already added∂ƒ\n    return;\n  }\n\n  this.edges.push([a, b]);\n  if (this.dependencies.has(a)) {\n    this.dependencies.get(a)!.add(b);\n  } else {\n    this.dependencies.set(a, new Set([b]));\n  }\n\n  if (this.dependents.has(b)) {\n    this.dependents.get(b)!.add(a);\n  } else {\n    this.dependents.set(b, new Set([a]));\n  }\n}\n\nexport default class DepsGraph {\n  public readonly imports: Map<string, (t.Identifier | t.StringLiteral)[]> =\n    new Map();\n\n  public readonly importAliases: Map<t.Identifier, string> = new Map();\n\n  public readonly importTypes: Map<\n    string,\n    'wildcard' | 'default' | 'reexport'\n  > = new Map();\n\n  public readonly reexports: Array<t.Identifier> = [];\n\n  protected readonly parents: WeakMap<t.Node, t.Node> = new WeakMap();\n\n  protected readonly edges: Array<[t.Node, t.Node]> = [];\n\n  protected readonly exports: Map<string, t.Node> = new Map();\n\n  protected readonly dependencies: Map<t.Node, Set<t.Node>> = new Map();\n\n  protected readonly dependents: Map<t.Node, Set<t.Node>> = new Map();\n\n  private actionQueue: Array<\n    [Action, t.Node | PromisedNode, t.Node | PromisedNode]\n  > = [];\n\n  private processQueue() {\n    if (this.actionQueue.length === 0) {\n      return;\n    }\n\n    this.actionQueue.forEach(([action, a, b]) => {\n      const resolvedA = resolveNode(a);\n      const resolvedB = resolveNode(b);\n      if (resolvedA && resolvedB) {\n        action.call(this, resolvedA, resolvedB);\n      }\n    });\n\n    this.actionQueue = [];\n  }\n\n  private getAllReferences(id: string): (t.Identifier | t.MemberExpression)[] {\n    const [, name] = id.split(':');\n    const declaration = this.scope.getDeclaration(id)!;\n    const allReferences: (t.Identifier | t.MemberExpression)[] = [\n      ...Array.from(this.dependencies.get(declaration) || []),\n      ...Array.from(this.dependents.get(declaration) || []),\n    ].filter((i) => t.isIdentifier(i) && i.name === name) as t.Identifier[];\n    allReferences.push(declaration);\n    return allReferences;\n  }\n\n  constructor(protected scope: ScopeManager) {}\n\n  addEdge(dependent: t.Node | PromisedNode, dependency: t.Node | PromisedNode) {\n    this.actionQueue.push([addEdge, dependent, dependency]);\n  }\n\n  addExport(name: string, node: t.Node) {\n    const existed = this.exports.get(name);\n    if (existed) {\n      // Sometimes export can be defined more than once and in that case we have to keep all export statements\n      this.addEdge(node, existed);\n    }\n\n    this.exports.set(name, node);\n  }\n\n  addParent(node: t.Node, parent: t.Node) {\n    this.parents.set(node, parent);\n  }\n\n  getParent(node: t.Node): t.Node | undefined {\n    return this.parents.get(node);\n  }\n\n  getDependenciesByBinding(id: string) {\n    this.processQueue();\n    const allReferences = this.getAllReferences(id);\n    const dependencies: t.Node[] = [];\n    this.edges.forEach(([a, b]) => {\n      if (t.isIdentifier(a) && allReferences.includes(a)) {\n        dependencies.push(b);\n      }\n    });\n\n    return dependencies;\n  }\n\n  getDependentsByBinding(id: string) {\n    this.processQueue();\n    const allReferences = this.getAllReferences(id);\n    const dependents: t.Node[] = [];\n    this.edges.forEach(([a, b]) => {\n      if (t.isIdentifier(b) && allReferences.includes(b)) {\n        dependents.push(a);\n      }\n    });\n\n    return dependents;\n  }\n\n  // eslint-disable-next-line @typescript-eslint/ban-types\n  findDependencies(like: Object) {\n    this.processQueue();\n    return this.edges\n      .filter(([a]) => t.shallowEqual(a, like))\n      .map(([, b]) => b);\n  }\n\n  findDependents(like: object) {\n    this.processQueue();\n    return this.edges\n      .filter(([, b]) => t.shallowEqual(b, like))\n      .map(([a]) => a);\n  }\n\n  getDependencies(nodes: t.Node[]) {\n    this.processQueue();\n    const reduced: t.Node[] = [];\n    nodes.forEach((n) =>\n      reduced.push(...Array.from(this.dependencies.get(n) || []))\n    );\n    return reduced;\n  }\n\n  getLeaf(name: string): t.Node | undefined {\n    return this.exports.get(name);\n  }\n\n  getLeaves(only: string[] | null): Array<t.Node | undefined> {\n    this.processQueue();\n    return only\n      ? only.map((name) => this.getLeaf(name))\n      : Array.from(this.exports.values());\n  }\n}\n"],"mappings":"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"}