{"version":3,"file":"Visitors.js","names":["visitors","Identifier","node","parent","parentKey","listIdx","handler","identifierHandlers","type","kindOfDeclaration","meta","get","scope","declare","declaration","addReference","graph","addEdge","context","peek","warn","name","core","isKeyOfVisitors","getVisitors","aliases","t","ALIAS_KEYS","aliasVisitors","map","filter","i","v"],"sources":["../src/Visitors.ts"],"sourcesContent":["import { types as t } from '@babel/core';\nimport type { Identifier, Node } from '@babel/types';\n\nimport { peek } from '@linaria/babel-preset';\nimport type { VisitorKeys } from '@linaria/babel-preset';\nimport { warn } from '@linaria/logger';\n\nimport type GraphBuilderState from './GraphBuilderState';\nimport identifierHandlers from './identifierHandlers';\nimport { visitors as core } from './langs/core';\nimport type { Visitor, Visitors } from './types';\n\nconst visitors: Visitors = {\n  Identifier<TParent extends Node>(\n    this: GraphBuilderState,\n    node: Identifier,\n    parent: TParent | null,\n    parentKey: VisitorKeys<TParent> | null,\n    listIdx: number | null = null\n  ) {\n    if (!parent || !parentKey) {\n      return;\n    }\n\n    const handler = identifierHandlers[`${parent.type}:${parentKey}`];\n\n    if (typeof handler === 'function') {\n      handler(this, node, parent, parentKey, listIdx);\n      return;\n    }\n\n    if (handler === 'keep') {\n      return;\n    }\n\n    if (handler === 'declare') {\n      const kindOfDeclaration = this.meta.get('kind-of-declaration');\n      this.scope.declare(node, kindOfDeclaration === 'var', null);\n      return;\n    }\n\n    if (handler === 'refer') {\n      const declaration = this.scope.addReference(node);\n      // Let's check that it's not a global variable\n      if (declaration) {\n        // usage of a variable depends on its declaration\n        this.graph.addEdge(node, declaration);\n\n        const context = peek(this.context);\n        if (context === 'lval') {\n          // This is an identifier in the left side of an assignment expression and a variable value depends on that.\n          this.graph.addEdge(declaration, node);\n        }\n      }\n\n      return;\n    }\n\n    /*\n     * There is an unhandled identifier.\n     * This case should be added to ./identifierHandlers.ts\n     */\n    warn(\n      'evaluator:shaker',\n      'Unhandled identifier',\n      node.name,\n      parent.type,\n      parentKey,\n      listIdx\n    );\n  },\n\n  ...core,\n};\n\nconst isKeyOfVisitors = (type: string): type is keyof Visitors =>\n  type in visitors;\n\nexport function getVisitors<TNode extends Node>(node: TNode): Visitor<TNode>[] {\n  const aliases = t.ALIAS_KEYS[node.type] || [];\n  const aliasVisitors = aliases\n    .map((type) => (isKeyOfVisitors(type) ? visitors[type] : null))\n    .filter((i) => i) as Visitor<TNode>[];\n  return [...aliasVisitors, visitors[node.type] as Visitor<TNode>].filter(\n    (v) => v\n  );\n}\n\nexport default visitors;\n"],"mappings":";;;;;;;;AAAA;;AAGA;;AAEA;;AAGA;;AACA;;;;AAGA,MAAMA,QAAkB,GAAG;EACzBC,UAAU,CAERC,IAFQ,EAGRC,MAHQ,EAIRC,SAJQ,EAKRC,OAAsB,GAAG,IALjB,EAMR;IACA,IAAI,CAACF,MAAD,IAAW,CAACC,SAAhB,EAA2B;MACzB;IACD;;IAED,MAAME,OAAO,GAAGC,2BAAA,CAAoB,GAAEJ,MAAM,CAACK,IAAK,IAAGJ,SAAU,EAA/C,CAAhB;;IAEA,IAAI,OAAOE,OAAP,KAAmB,UAAvB,EAAmC;MACjCA,OAAO,CAAC,IAAD,EAAOJ,IAAP,EAAaC,MAAb,EAAqBC,SAArB,EAAgCC,OAAhC,CAAP;MACA;IACD;;IAED,IAAIC,OAAO,KAAK,MAAhB,EAAwB;MACtB;IACD;;IAED,IAAIA,OAAO,KAAK,SAAhB,EAA2B;MACzB,MAAMG,iBAAiB,GAAG,KAAKC,IAAL,CAAUC,GAAV,CAAc,qBAAd,CAA1B;MACA,KAAKC,KAAL,CAAWC,OAAX,CAAmBX,IAAnB,EAAyBO,iBAAiB,KAAK,KAA/C,EAAsD,IAAtD;MACA;IACD;;IAED,IAAIH,OAAO,KAAK,OAAhB,EAAyB;MACvB,MAAMQ,WAAW,GAAG,KAAKF,KAAL,CAAWG,YAAX,CAAwBb,IAAxB,CAApB,CADuB,CAEvB;;MACA,IAAIY,WAAJ,EAAiB;QACf;QACA,KAAKE,KAAL,CAAWC,OAAX,CAAmBf,IAAnB,EAAyBY,WAAzB;QAEA,MAAMI,OAAO,GAAG,IAAAC,iBAAA,EAAK,KAAKD,OAAV,CAAhB;;QACA,IAAIA,OAAO,KAAK,MAAhB,EAAwB;UACtB;UACA,KAAKF,KAAL,CAAWC,OAAX,CAAmBH,WAAnB,EAAgCZ,IAAhC;QACD;MACF;;MAED;IACD;IAED;AACJ;AACA;AACA;;;IACI,IAAAkB,YAAA,EACE,kBADF,EAEE,sBAFF,EAGElB,IAAI,CAACmB,IAHP,EAIElB,MAAM,CAACK,IAJT,EAKEJ,SALF,EAMEC,OANF;EAQD,CA1DwB;;EA4DzB,GAAGiB;AA5DsB,CAA3B;;AA+DA,MAAMC,eAAe,GAAIf,IAAD,IACtBA,IAAI,IAAIR,QADV;;AAGO,SAASwB,WAAT,CAAyCtB,IAAzC,EAAwE;EAC7E,MAAMuB,OAAO,GAAGC,WAAA,CAAEC,UAAF,CAAazB,IAAI,CAACM,IAAlB,KAA2B,EAA3C;EACA,MAAMoB,aAAa,GAAGH,OAAO,CAC1BI,GADmB,CACdrB,IAAD,IAAWe,eAAe,CAACf,IAAD,CAAf,GAAwBR,QAAQ,CAACQ,IAAD,CAAhC,GAAyC,IADrC,EAEnBsB,MAFmB,CAEXC,CAAD,IAAOA,CAFK,CAAtB;EAGA,OAAO,CAAC,GAAGH,aAAJ,EAAmB5B,QAAQ,CAACE,IAAI,CAACM,IAAN,CAA3B,EAA0DsB,MAA1D,CACJE,CAAD,IAAOA,CADF,CAAP;AAGD;;eAEchC,Q"}