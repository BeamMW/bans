{"version":3,"file":"shaker.js","names":["generator","isNode","getVisitorKeys","debug","dumpNode","build","shakeNode","node","alive","keys","changes","isNodeAlive","n","has","forEach","key","subNode","Array","isArray","list","hasChanges","i","length","child","isAlive","shaken","push","undefined","Object","isDefined","shake","rootPath","exports","join","code","depsGraph","Set","reexports","deps","map","token","getLeaves","filter","getLeaf","reduce","acc","el","d","add","getDependencies","imports","Map","entries","source","members","importType","importTypes","get","defaultMembers","aliveMembers","type","name","value","set","size","from"],"sources":["../src/shaker.ts"],"sourcesContent":["import generator from '@babel/generator';\nimport type { Node, Program } from '@babel/types';\n\nimport { isNode, getVisitorKeys } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport dumpNode from './dumpNode';\nimport build from './graphBuilder';\n\n/*\n * Returns new tree without dead nodes\n */\nfunction shakeNode<TNode extends Node>(node: TNode, alive: Set<Node>): Node {\n  const keys = getVisitorKeys(node) as Array<keyof TNode>;\n  const changes: Partial<TNode> = {};\n  const isNodeAlive = (n: Node) => alive.has(n);\n\n  keys.forEach((key) => {\n    const subNode = node[key];\n\n    if (Array.isArray(subNode)) {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const list: any = [];\n      let hasChanges = false;\n      for (let i = 0; i < subNode.length; i++) {\n        const child = subNode[i];\n        const isAlive = isNodeAlive(child);\n        hasChanges = hasChanges || !isAlive;\n        if (child && isAlive) {\n          const shaken = shakeNode(child, alive);\n          if (shaken) {\n            list.push(shaken);\n          }\n\n          hasChanges = hasChanges || shaken !== child;\n        }\n      }\n      if (hasChanges) {\n        changes[key] = list;\n      }\n    } else if (isNode(subNode)) {\n      if (isNodeAlive(subNode)) {\n        const shaken = shakeNode(subNode, alive);\n        if (shaken && shaken !== subNode) {\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          changes[key] = shaken as any;\n        }\n      } else {\n        changes[key] = undefined;\n      }\n    }\n  });\n\n  return Object.keys(changes).length ? { ...node, ...changes } : node;\n}\n\nconst isDefined = <T>(i: T | undefined): i is T => i !== undefined;\n\n/*\n * Gets AST and a list of nodes for evaluation\n * Removes unrelated “dead” code.\n * Adds to the end of module export of array of evaluated values or evaluation errors.\n * Returns new AST and an array of external dependencies.\n */\nexport default function shake(\n  rootPath: Program,\n  exports: string[] | null\n): [Program, Map<string, string[]>] {\n  debug(\n    'evaluator:shaker:shake',\n    () =>\n      `source (exports: ${(exports || []).join(', ')}):\\n${\n        generator(rootPath).code\n      }`\n  );\n\n  const depsGraph = build(rootPath);\n  const alive = new Set<Node>();\n  const reexports: string[] = [];\n  let deps = (exports ?? [])\n    .map((token) => {\n      if (token === '*') {\n        return depsGraph.getLeaves(null).filter(isDefined);\n      }\n\n      const node = depsGraph.getLeaf(token);\n      if (node) return [node];\n      // We have some unknown token. Do we have `export * from …` in that file?\n      if (depsGraph.reexports.length === 0) {\n        return [];\n      }\n\n      // If so, mark all re-exported files as required\n      reexports.push(token);\n      return [...depsGraph.reexports];\n    })\n    .reduce<Node[]>((acc, el) => {\n      acc.push(...el);\n      return acc;\n    }, []);\n  while (deps.length > 0) {\n    // Mark all dependencies as alive\n    deps.forEach((d) => alive.add(d));\n\n    // Collect new dependencies of dependencies\n    deps = depsGraph.getDependencies(deps).filter((d) => !alive.has(d));\n  }\n\n  const shaken = shakeNode(rootPath, alive) as Program;\n  /*\n   * If we want to know what is really happen with our code tree,\n   * we can print formatted tree here by setting env variable LINARIA_LOG=debug\n   */\n  debug('evaluator:shaker:shake', () => dumpNode(rootPath, alive));\n\n  const imports = new Map<string, string[]>();\n  [...depsGraph.imports.entries()].forEach(([source, members]) => {\n    const importType = depsGraph.importTypes.get(source);\n    const defaultMembers = importType === 'wildcard' ? ['*'] : [];\n    const aliveMembers = new Set(\n      members\n        .filter((i) => alive.has(i))\n        .map((i) => (i.type === 'Identifier' ? i.name : i.value))\n    );\n\n    if (importType === 'reexport') {\n      reexports.forEach((token) => aliveMembers.add(token));\n    }\n\n    imports.set(\n      source,\n      aliveMembers.size > 0 ? Array.from(aliveMembers) : defaultMembers\n    );\n  });\n\n  return [shaken, imports];\n}\n"],"mappings":"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"}