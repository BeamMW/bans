{"version":3,"file":"index.js","names":["transformSync","generator","buildOptions","debug","shake","default","buildDepsGraph","prepareForShake","filename","options","code","transformOptions","ast","presets","unshift","require","resolve","targets","plugins","useESModules","JSON","stringify","transformed","Error","program","shaker","text","only","shaken","imports","shakenCode"],"sources":["../src/index.ts"],"sourcesContent":["import { transformSync } from '@babel/core';\nimport generator from '@babel/generator';\nimport type { Program } from '@babel/types';\n\nimport type { Evaluator, StrictOptions } from '@linaria/babel-preset';\nimport { buildOptions } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport shake from './shaker';\n\nexport { default as buildDepsGraph } from './graphBuilder';\n\nfunction prepareForShake(\n  filename: string,\n  options: StrictOptions,\n  code: string\n): Program {\n  const transformOptions = buildOptions(filename, options);\n\n  transformOptions.ast = true;\n  transformOptions.presets!.unshift([\n    require.resolve('@babel/preset-env'),\n    {\n      targets: 'ie 11',\n    },\n  ]);\n  transformOptions.presets!.unshift([\n    require.resolve('@linaria/preeval'),\n    options,\n  ]);\n  transformOptions.plugins!.unshift(\n    require.resolve('babel-plugin-transform-react-remove-prop-types')\n  );\n  transformOptions.plugins!.unshift([\n    require.resolve('@babel/plugin-transform-runtime'),\n    { useESModules: false },\n  ]);\n\n  debug(\n    'evaluator:shaker:transform',\n    `Transform ${filename} with options ${JSON.stringify(\n      transformOptions,\n      null,\n      2\n    )}`\n  );\n  const transformed = transformSync(code, transformOptions);\n\n  if (transformed === null || !transformed.ast) {\n    throw new Error(`${filename} cannot be transformed`);\n  }\n\n  return transformed.ast.program;\n}\n\nconst shaker: Evaluator = (filename, options, text, only = null) => {\n  const [shaken, imports] = shake(\n    prepareForShake(filename, options, text),\n    only\n  );\n\n  debug('evaluator:shaker:generate', `Generate shaken source code ${filename}`);\n  const { code: shakenCode } = generator(shaken!);\n  return [shakenCode, imports];\n};\n\nexport default shaker;\n"],"mappings":"AAAA,SAASA,aAAT,QAA8B,aAA9B;AACA,OAAOC,SAAP,MAAsB,kBAAtB;AAIA,SAASC,YAAT,QAA6B,uBAA7B;AACA,SAASC,KAAT,QAAsB,iBAAtB;AAEA,OAAOC,KAAP,MAAkB,UAAlB;AAEA,SAASC,OAAO,IAAIC,cAApB,QAA0C,gBAA1C;;AAEA,SAASC,eAAT,CACEC,QADF,EAEEC,OAFF,EAGEC,IAHF,EAIW;EACT,MAAMC,gBAAgB,GAAGT,YAAY,CAACM,QAAD,EAAWC,OAAX,CAArC;EAEAE,gBAAgB,CAACC,GAAjB,GAAuB,IAAvB;EACAD,gBAAgB,CAACE,OAAjB,CAA0BC,OAA1B,CAAkC,CAChCC,OAAO,CAACC,OAAR,CAAgB,mBAAhB,CADgC,EAEhC;IACEC,OAAO,EAAE;EADX,CAFgC,CAAlC;EAMAN,gBAAgB,CAACE,OAAjB,CAA0BC,OAA1B,CAAkC,CAChCC,OAAO,CAACC,OAAR,CAAgB,kBAAhB,CADgC,EAEhCP,OAFgC,CAAlC;EAIAE,gBAAgB,CAACO,OAAjB,CAA0BJ,OAA1B,CACEC,OAAO,CAACC,OAAR,CAAgB,gDAAhB,CADF;EAGAL,gBAAgB,CAACO,OAAjB,CAA0BJ,OAA1B,CAAkC,CAChCC,OAAO,CAACC,OAAR,CAAgB,iCAAhB,CADgC,EAEhC;IAAEG,YAAY,EAAE;EAAhB,CAFgC,CAAlC;EAKAhB,KAAK,CACH,4BADG,EAEF,aAAYK,QAAS,iBAAgBY,IAAI,CAACC,SAAL,CACpCV,gBADoC,EAEpC,IAFoC,EAGpC,CAHoC,CAIpC,EANC,CAAL;EAQA,MAAMW,WAAW,GAAGtB,aAAa,CAACU,IAAD,EAAOC,gBAAP,CAAjC;;EAEA,IAAIW,WAAW,KAAK,IAAhB,IAAwB,CAACA,WAAW,CAACV,GAAzC,EAA8C;IAC5C,MAAM,IAAIW,KAAJ,CAAW,GAAEf,QAAS,wBAAtB,CAAN;EACD;;EAED,OAAOc,WAAW,CAACV,GAAZ,CAAgBY,OAAvB;AACD;;AAED,MAAMC,MAAiB,GAAG,CAACjB,QAAD,EAAWC,OAAX,EAAoBiB,IAApB,EAA0BC,IAAI,GAAG,IAAjC,KAA0C;EAClE,MAAM,CAACC,MAAD,EAASC,OAAT,IAAoBzB,KAAK,CAC7BG,eAAe,CAACC,QAAD,EAAWC,OAAX,EAAoBiB,IAApB,CADc,EAE7BC,IAF6B,CAA/B;EAKAxB,KAAK,CAAC,2BAAD,EAA+B,+BAA8BK,QAAS,EAAtE,CAAL;EACA,MAAM;IAAEE,IAAI,EAAEoB;EAAR,IAAuB7B,SAAS,CAAC2B,MAAD,CAAtC;EACA,OAAO,CAACE,UAAD,EAAaD,OAAb,CAAP;AACD,CATD;;AAWA,eAAeJ,MAAf"}